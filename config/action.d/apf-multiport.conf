# Fail2Ban configuration file
#
# multiport ban action for APF
#  - https://www.rfxn.com/projects/advanced-policy-firewall/
#
# Author: David Gabriel <b2c@dest-unreachable.net>
#
# apf config hint: add something like this to apf/postroute.rules 
#
# if pgrep -f '^\/usr\/bin\/python.*fail2ban-server' 2>&1 >/dev/null; then
#   eout "{glob} restarting fail2ban"
#   /usr/bin/fail2ban-client reload || true
# fi


[Init]
chain      = INPUT
name       = f2b-apf-multiport
protocol   = tcp
blocktype  = REJECT --reject-with icmp-port-unreachable
returntype = RETURN
lockingopt = -w
iptables   = iptables <lockingopt>

[Definition]
actionstart = <iptables> -n -L <chain> | grep -q '<name>[ \t]' || {
                <iptables> -N <name>
                <iptables> -A <name>  -j <returntype>
                <iptables> -I <chain> -j <name>
              }

actionstop  = <iptables> -n -L <chain> | grep -q '<name>[ \t]' || {
              <iptables> -D <chain> -j <name> 2>/dev/null || true
              <iptables> -F <name> 2>/dev/null || true
              <iptables> -X <name> 2>/dev/null || true
              }

actioncheck = <iptables> -n -L <chain> | grep -q '<name>[ \t]'
actionban   = <iptables> -I <name> 1 -s <ip> -p <protocol> -m multiport --dport <port> -j <blocktype>
actionunban = <iptables> -D <name>   -s <ip> -p <protocol> -m multiport --dport <port> -j <blocktype>
