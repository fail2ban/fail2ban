# Fail2Ban action file for firewall-cmd/ipset
#
# This requires:
# ipset (package: ipset)
# firewall-cmd (package: firewalld)
#
# This is for ipset protocol 6 (and hopefully later) (ipset v6.14).
# Use ipset -V to see the protocol and version.
#
# This also supports nftables ipsets, which supercedes the older ipset
# protocol since kernel version 3.13
#
# using the default firewall-cmd command set is quite slow at adding a large
# number of ip addresses (at startup and shutdown for example), so using the
# ipset or nftables backends may improve performance quite a lot.
#
# IPset was a feature introduced in the linux kernel 2.6.39 and 3.0.0 kernels.
# nftables was a feature introduced in the linkux kernel 3.13.
#
# If you are running on an older kernel you make need to patch in external
# modules.

[INCLUDES]

before = firewallcmd-common.conf

[Definition]

actionstart = <ipsbackend_<ipsetbackend>/actionstart>

actionflush = <ipsbackend_<ipsetbackend>/actionflush>

actionstop = <actionflush>
             <ipsbackend_<ipsetbackend>/actionstop>

actionban = <ipsbackend_<ipsetbackend>/actionban>

# actionprolong = %(actionban)s

actionunban = <ipsbackend_<ipsetbackend>/actionunban>

[ipsbackend_ipset]

actionstart = ipset -exist create <ipmset> <ipsettype> timeout <default-ipsettime> maxelem <maxelem> <familyopt>
              firewall-cmd --direct --add-rule <family> filter <chain> 0 <actiontype> -m set --match-set <ipmset> src -j <blocktype>

actionflush = ipset flush <ipmset>

actionstop = firewall-cmd --direct --remove-rule <family> filter <chain> 0 <actiontype> -m set --match-set <ipmset> src -j <blocktype>
             ipset destroy <ipmset> 2>/dev/null || { sleep 1; ipset destroy <ipmset>; }

actionban = ipset -exist add <ipmset> <ip> timeout <ipsettime>

actionunban = ipset -exist del <ipmset> <ip>

[ipsbackend_nftables]
# TODO: Currently only works with allports, add support for multiport
actionstart = firewall-cmd --permanent --new-ipset=<ipmset> --type=<ipsettype> --option=maxelem=<maxelem>
              firewall-cmd --reload
              firewall-cmd --zone=<blockzone> --add-source=ipset:<ipmset>

actionflush = nft flush set inet firewalld <ipmset>

actionstop = firewall-cmd --zone=<blockzone> --remove-source=ipset:<ipmset>
             firewall-cmd --permanent --delete-ipset=<ipmset>
             firewall-cmd --reload

actionban = nft add element inet firewalld <ipmset> { <ip> }

actionunban = nft delete element inet firewalld <ipmset> { <ip> }


[ipsbackend_firewalld]

actionstart = firewall-cmd --direct --new-ipset=<ipmset> --type=<ipsettype> --option=timeout=<default-ipsettime> --option=maxelem=<maxelem> <firewalld_familyopt>
              firewall-cmd --direct --add-rule <family> filter <chain> 0 <actiontype> -m set --match-set <ipmset> src -j <blocktype>

# TODO: there doesn't seem to be an explicit way to invoke the ipset flush function using firewall-cmd
actionflush = 

actionstop = firewall-cmd --direct --remove-rule <family> filter <chain> 0 <actiontype> -m set --match-set <ipmset> src -j <blocktype>
             firewall-cmd --direct --delete-ipset=<ipmset>

actionban = firewall-cmd --ipset=<ipmset> --add-entry=<ip>

actionunban = firewall-cmd --ipset=<ipmset> --remove-entry=<ip>

[Init]

# Option: ipsettype
# Notes:  specifies type of set, see `man --pager='less -p "^SET TYPES"' ipset` for details
# Values: hash:ip, hash:net, etc... Default: hash:ip
ipsettype = hash:ip

# Option:  chain
# Notes    specifies the iptables chain to which the fail2ban rules should be
#          added
# Values:  [ STRING ]
#
chain = INPUT_direct

# Option: default-ipsettime
# Notes:  specifies default timeout in seconds (handled default ipset timeout only)
# Values:  [ NUM ]  Default: 0 (no timeout, managed by fail2ban by unban)
default-ipsettime = 0

# Option: ipsettime
# Notes:  specifies ticket timeout (handled ipset timeout only)
# Values:  [ NUM ]  Default: 0 (managed by fail2ban by unban)
ipsettime = 0

# Option: maxelem
# Notes:  maximal number of elements which can be stored in the ipset
#         You may want to increase this for long-duration/high-volume jails
# Values: [ NUM ] Default: 65536
maxelem = 65536

# expression to calculate timeout from bantime, example:
# banaction = %(known/banaction)s[ipsettime='<timeout-bantime>']
timeout-bantime = $([ "<bantime>" -le 2147483 ] && echo "<bantime>" || echo 0)

# Option: ipsetbackend
# Notes.: defines the backend of ipset used for match-set (firewalld or ipset)
# Values: firewalld, nftables or ipset
# Default: ipset
ipsetbackend = nftables

# Option:  blockzone
# Notes    firewalld zone to use when blocking targets. Common values are block and drop.
# Values:  STRING
blockzone = block

# Option: actiontype
# Notes.: defines additions to the blocking rule
# Values: leave empty to block all attempts from the host
# Default: Value of the multiport
actiontype = <multiport>

# Option: allports
# Notes.: default addition to block all ports
# Usage.: use in jail config:  banaction = firewallcmd-ipset[actiontype=<allports>]
#         for all protocols:   banaction = firewallcmd-ipset[actiontype=""]
allports = -p <protocol>

# Option: multiport
# Notes.: addition to block access only to specific ports
# Usage.: use in jail config:  banaction = firewallcmd-ipset[actiontype=<multiport>]
multiport = -p <protocol> -m multiport --dports <port>

ipmset = f2b-<name>
familyopt =
firewalld_familyopt =

[Init?family=inet6]

ipmset = f2b-<name>6
familyopt = family inet6
firewalld_familyopt = --option=family=inet6


# DEV NOTES:
#
# Author: Edgar Hoch, Daniel Black, Sergey Brester, Mihail Politaev and Sebastian Pauka
# firewallcmd-new / iptables-ipset-proto6 combined for maximum goodness
