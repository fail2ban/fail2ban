# Fail2Ban filter to match failed userlogin attempts as notified by mattermost's logfile
#
# Mattermost has two formats be configured in 'config/config.json'
# example loglines for both formats can be found in https://github.com/fail2ban/fail2ban/blob/0.11/fail2ban/tests/files/logs/mattermost

[DEFAULT]

# helper used to bypass json key-value attribute(s):
_bypass_part = (?:"\w+"\s*:\s*(?:"[^"]*"|\S+)\s*,\s*)*

# format of log (corresponding "LogSettings -> FileJson" configuration, typically set to true in production.),
# this can be overwritten in jail.local using:
#   filter = mattermost[filejson=false]
# or in filter.d/mattermost.local in definition section
filejson = true

[Definition]

failregex = <fj_<filejson>/failregex>
datepattern = <fj_<filejson>/datepattern>

ignoreregex =

[fj_false]
# For this one to work "LogSettings -> FileJson" needs to be set to 'false'
datepattern =
failregex = ^\s*error\s+[^\{]*\{\s*%(_bypass_part)s"ip_addr":\s*"<ADDR>"\s*,\s*%(_bypass_part)s"err_where"\s*:\s*"(?:checkUserPassword|GetUserForLogin|ValidateToken)"

[fj_true]
# For this one to work "LogSettings -> FileJson" needs to be set to 'true' (typically set to true in production.)
datepattern = ^\{"level"\s*:\s*"error",\s*"ts":{Epoch}\d*,
failregex = ^\s*%(_bypass_part)s"ip_addr":\s*"<ADDR>"\s*,\s*%(_bypass_part)s"err_where"\s*:\s*"(?:checkUserPassword|GetUserForLogin|ValidateToken)"

# Author: Idar Lund <idarlund@gmail.com>, Sergey Brester (aka sebres)